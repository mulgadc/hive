import{k as D,r as S,j as e,c as K,B as C,aF as Z,aG as Y,aH as J,n as U,ay as _,L as k}from"./index.js";import{u as P}from"./useSuspenseQuery.js";import{B as z}from"./back-link.js";import{D as x,a as r}from"./detail-row.js";import{E as T}from"./error-banner.js";import{P as W}from"./page-heading.js";import{S as X}from"./state-badge.js";import{g as O,f as V,b as E,a as B,c as R,d as $,e as H,h as G}from"./alert-dialog.js";import{b as A,a as w}from"./field.js";import{S as ee,a as se,b as te,c as ae,d as ne}from"./select.js";import{p as ie,q as re,r as le,s as oe,t as ce,v as de,w as me}from"./ec2.js";import{A as ue}from"./ami-details.js";import{I as pe}from"./input.js";import{T as he}from"./textarea.js";import{T as xe}from"./trash-2.js";import"./check.js";const ge=[["path",{d:"M16 5h6",key:"1vod17"}],["path",{d:"M19 2v6",key:"4bpg5p"}],["path",{d:"M21 11.5V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h7.5",key:"1ue2ih"}],["path",{d:"m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21",key:"1xmnt7"}],["circle",{cx:"9",cy:"9",r:"2",key:"af1f0g"}]],je=D("image-plus",ge);const Ie=[["rect",{x:"14",y:"3",width:"5",height:"18",rx:"1",key:"kaeet6"}],["rect",{x:"5",y:"3",width:"5",height:"18",rx:"1",key:"1wsw3u"}]],ye=D("pause",Ie);const fe=[["path",{d:"M5 5a2 2 0 0 1 3.008-1.728l11.997 6.998a2 2 0 0 1 .003 3.458l-12 7A2 2 0 0 1 5 19z",key:"10ikf1"}]],be=D("play",fe);const ve=[["path",{d:"M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8",key:"1p45f6"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}]],Se=D("rotate-cw",ve);const Ce=[["path",{d:"M14 17H5",key:"gfn3mx"}],["path",{d:"M19 7h-9",key:"6i9tg"}],["circle",{cx:"17",cy:"17",r:"3",key:"18b49y"}],["circle",{cx:"7",cy:"7",r:"3",key:"dfmy0x"}]],Ne=D("settings-2",Ce);const Te=[["path",{d:"M12 19h8",key:"baeox8"}],["path",{d:"m4 17 6-6-6-6",key:"1yngyt"}]],De=D("terminal",Te);function ke({instanceId:b,open:s,onOpenChange:t}){const n=ie(),[c,d]=S.useState(""),[l,i]=S.useState(""),[g,p]=S.useState(null);function m(o){o||(d(""),i(""),p(null)),t(o)}async function u(){try{const o=await n.mutateAsync({instanceId:b,name:c,description:l||void 0});p(o.ImageId??null),d(""),i("")}catch{}}return e.jsx(O,{onOpenChange:m,open:s,children:e.jsxs(V,{children:[e.jsxs(E,{children:[e.jsx(B,{children:g?"Image Created":"Create Image (AMI)"}),e.jsx(R,{children:g?`Image "${g}" was created successfully.`:`Create an AMI from instance "${b}".`})]}),!g&&e.jsxs(e.Fragment,{children:[e.jsxs(A,{children:[e.jsx(w,{children:e.jsx("label",{htmlFor:"imageName",children:"Name"})}),e.jsx(pe,{id:"imageName",onChange:o=>d(o.target.value),placeholder:"my-image",value:c})]}),e.jsxs(A,{children:[e.jsx(w,{children:e.jsx("label",{htmlFor:"imageDescription",children:"Description"})}),e.jsx(he,{id:"imageDescription",onChange:o=>i(o.target.value),placeholder:"Optional description",rows:2,value:l})]})]}),e.jsxs($,{children:[e.jsx(H,{children:g?"Close":"Cancel"}),!g&&e.jsx(G,{disabled:n.isPending||!c.trim(),onClick:u,children:n.isPending?"Creating…":"Create Image"})]})]})})}const Pe=["pending","stopping","shutting-down","terminated"];function Ae(b){const s=K.c(35),{instanceId:t,state:n}=b,c=re(),d=le(),l=oe(),i=ce();if(Pe.includes(n||"")&&n!=="terminated"){let h;return s[0]!==n?(h=e.jsx("div",{className:"rounded-lg border bg-muted/50 p-4",children:e.jsxs("p",{className:"text-center text-muted-foreground text-sm",children:["Instance is ",n,". Actions will be available once the operation completes."]})}),s[0]=n,s[1]=h):h=s[1],h}if(n==="terminated"){let h;return s[2]===Symbol.for("react.memo_cache_sentinel")?(h=e.jsx("div",{className:"rounded-lg border bg-muted/50 p-4",children:e.jsx("p",{className:"text-center text-muted-foreground text-sm",children:"This instance has been terminated and cannot be managed."})}),s[2]=h):h=s[2],h}let p;s[3]===Symbol.for("react.memo_cache_sentinel")?(p=e.jsx("h2",{className:"mb-4 font-semibold",children:"Instance Actions"}),s[3]=p):p=s[3];let m;s[4]!==c.error?(m=c.error&&e.jsx(T,{error:c.error,msg:"Failed to start instance"}),s[4]=c.error,s[5]=m):m=s[5];let u;s[6]!==d.error?(u=d.error&&e.jsx(T,{error:d.error,msg:"Failed to stop instance"}),s[6]=d.error,s[7]=u):u=s[7];let o;s[8]!==l.error?(o=l.error&&e.jsx(T,{error:l.error,msg:"Failed to reboot instance"}),s[8]=l.error,s[9]=o):o=s[9];let j;s[10]!==i.error?(j=i.error&&e.jsx(T,{error:i.error,msg:"Failed to terminate instance"}),s[10]=i.error,s[11]=j):j=s[11];let I;s[12]!==t||s[13]!==c||s[14]!==n?(I=n==="stopped"&&e.jsxs(C,{disabled:c.isPending,onClick:()=>c.mutate(t),size:"sm",variant:"default",children:[e.jsx(be,{className:"size-4"}),c.isPending?"Starting":"Start"]}),s[12]=t,s[13]=c,s[14]=n,s[15]=I):I=s[15];let y;s[16]!==t||s[17]!==l||s[18]!==n||s[19]!==d?(y=n==="running"&&e.jsxs(e.Fragment,{children:[e.jsxs(C,{disabled:d.isPending,onClick:()=>d.mutate(t),size:"sm",variant:"outline",children:[e.jsx(ye,{className:"size-4"}),d.isPending?"Stopping":"Stop"]}),e.jsxs(C,{disabled:l.isPending,onClick:()=>l.mutate(t),size:"sm",variant:"outline",children:[e.jsx(Se,{className:"size-4"}),l.isPending?"Rebooting":"Reboot"]})]}),s[16]=t,s[17]=l,s[18]=n,s[19]=d,s[20]=y):y=s[20];let v;s[21]!==t||s[22]!==n||s[23]!==i?(v=(n==="stopped"||n==="running")&&e.jsxs(C,{disabled:i.isPending,onClick:()=>i.mutate(t),size:"sm",variant:"destructive",children:[e.jsx(xe,{className:"size-4"}),i.isPending?"Terminating":"Terminate"]}),s[21]=t,s[22]=n,s[23]=i,s[24]=v):v=s[24];let f;s[25]!==I||s[26]!==y||s[27]!==v?(f=e.jsxs("div",{className:"flex flex-wrap gap-2",children:[I,y,v]}),s[25]=I,s[26]=y,s[27]=v,s[28]=f):f=s[28];let N;return s[29]!==m||s[30]!==u||s[31]!==o||s[32]!==j||s[33]!==f?(N=e.jsxs("div",{className:"rounded-lg border bg-card p-4",children:[p,m,u,o,j,f]}),s[29]=m,s[30]=u,s[31]=o,s[32]=j,s[33]=f,s[34]=N):N=s[34],N}function Ke(){const{id:b}=Z.useParams(),{data:s}=P(Y(b)),t=s.Reservations?.[0]?.Instances?.[0],{data:n}=P(J(t?.ImageId)),c=n?.Images?.[0],{data:d}=P(U),l=de(),i=me(),[g,p]=S.useState(!1),[m,u]=S.useState(""),[o,j]=S.useState(!1),[I,y]=S.useState(null),[v,f]=S.useState(!1),N=[...new Set(d.InstanceTypes?.flatMap(a=>a.InstanceType?[a.InstanceType]:[]))].toSorted();if(!t?.InstanceId)return e.jsxs(e.Fragment,{children:[e.jsx(z,{to:"/ec2/describe-instances",children:"Back to instances"}),e.jsx("p",{className:"text-muted-foreground",children:"Instance not found."})]});const h=_(t.LaunchTime),M=t.State?.Name==="running",F=t.State?.Name==="stopped";async function L(){try{await l.mutateAsync({instanceId:b,instanceType:m}),p(!1),u("")}catch{}}async function Q(){try{const a=await i.mutateAsync(b),q=a.Output?atob(a.Output):"(no output)";y(q),j(!0)}catch{}}return e.jsxs(e.Fragment,{children:[e.jsx(z,{to:"/ec2/describe-instances",children:"Back to instances"}),l.error&&e.jsx(T,{error:l.error,msg:"Failed to modify instance"}),i.error&&e.jsx(T,{error:i.error,msg:"Failed to get console output"}),e.jsxs("div",{className:"space-y-6",children:[e.jsx(W,{actions:e.jsxs("div",{className:"flex items-center gap-2",children:[M&&e.jsxs(C,{disabled:i.isPending,onClick:Q,size:"sm",variant:"outline",children:[e.jsx(De,{className:"size-4"}),i.isPending?"Fetching…":"View Console"]}),(M||F)&&e.jsxs(C,{onClick:()=>f(!0),size:"sm",variant:"outline",children:[e.jsx(je,{className:"size-4"}),"Create Image"]}),F&&e.jsxs(C,{onClick:()=>{u(t.InstanceType??""),p(!0)},size:"sm",variant:"outline",children:[e.jsx(Ne,{className:"size-4"}),"Modify Instance"]}),e.jsx(X,{state:t.State?.Name})]}),subtitle:"EC2 Instance Details",title:t.InstanceId}),e.jsx(Ae,{instanceId:t.InstanceId,state:t.State?.Name}),o&&I!==null&&e.jsxs(x,{children:[e.jsx(x.Header,{children:e.jsxs("div",{className:"flex items-center justify-between",children:["Console Output",e.jsx(C,{onClick:()=>{j(!1),y(null)},size:"sm",variant:"ghost",children:"Hide"})]})}),e.jsx("div",{className:"p-4",children:e.jsx("pre",{className:"max-h-96 overflow-y-auto whitespace-pre-wrap rounded bg-muted p-3 font-mono text-xs",children:I})})]}),e.jsxs(x,{children:[e.jsx(x.Header,{children:"Instance Information"}),e.jsxs(x.Content,{children:[e.jsx(r,{label:"Instance ID",value:t.InstanceId}),e.jsx(r,{label:"Instance Type",value:t.InstanceType}),e.jsx(r,{label:"Instance State",value:t.State?.Name}),e.jsx(r,{label:"State Code",value:t.State?.Code?.toString()}),e.jsx(r,{label:"Launch Time",value:h}),e.jsx(r,{label:"Availability Zone",value:t.Placement?.AvailabilityZone})]})]}),(t.PrivateIpAddress||t.PublicIpAddress||t.VpcId||t.SubnetId||t.SecurityGroups&&t.SecurityGroups.length>0)&&e.jsxs(x,{children:[e.jsx(x.Header,{children:"Network & Security"}),e.jsxs(x.Content,{children:[e.jsx(r,{label:"Private IP Address",value:t.PrivateIpAddress}),e.jsx(r,{label:"Public IP Address",value:t.PublicIpAddress}),e.jsx(r,{label:"Private DNS",value:t.PrivateDnsName}),e.jsx(r,{label:"Public DNS",value:t.PublicDnsName}),e.jsx(r,{label:"VPC ID",value:t.VpcId?e.jsx(k,{className:"text-primary hover:underline",params:{id:t.VpcId},to:"/ec2/describe-vpcs/$id",children:t.VpcId}):void 0}),e.jsx(r,{label:"Subnet ID",value:t.SubnetId?e.jsx(k,{className:"text-primary hover:underline",params:{id:t.SubnetId},to:"/ec2/describe-subnets/$id",children:t.SubnetId}):void 0}),e.jsx(r,{label:"Key Name",value:t.KeyName}),e.jsx(r,{label:"Security Groups",value:t.SecurityGroups?.map(a=>a.GroupName).join(", ")})]})]}),t.BlockDeviceMappings&&t.BlockDeviceMappings.length>0&&e.jsxs(x,{children:[e.jsx(x.Header,{children:"Block Device Mappings"}),t.BlockDeviceMappings.map(a=>e.jsxs(x.Content,{children:[e.jsx(r,{label:"Device Name",value:a.DeviceName}),e.jsx(r,{label:"Volume ID",value:a.Ebs?.VolumeId?e.jsx(k,{className:"text-primary hover:underline",params:{id:a.Ebs.VolumeId},to:"/ec2/describe-volumes/$id",children:a.Ebs.VolumeId}):void 0}),e.jsx(r,{label:"Status",value:a.Ebs?.Status}),e.jsx(r,{label:"Attach Time",value:_(a.Ebs?.AttachTime)}),e.jsx(r,{label:"Delete on Termination",value:a.Ebs?.DeleteOnTermination?"Yes":"No"})]},a.DeviceName))]}),c&&e.jsx(ue,{image:c})]}),e.jsx(O,{onOpenChange:a=>{a||(p(!1),u(""))},open:g,children:e.jsxs(V,{children:[e.jsxs(E,{children:[e.jsx(B,{children:"Modify Instance"}),e.jsxs(R,{children:['Select a new instance type for "',t.InstanceId,'". The instance must be stopped to modify its attributes.']})]}),e.jsxs(A,{children:[e.jsx(w,{children:e.jsx("label",{htmlFor:"instanceType",children:"Instance Type"})}),e.jsxs(ee,{onValueChange:a=>u(a??""),value:m,children:[e.jsx(se,{className:"w-full",id:"instanceType",children:e.jsx(te,{})}),e.jsx(ae,{children:N.map(a=>e.jsx(ne,{value:a,children:a},a))})]})]}),e.jsxs($,{children:[e.jsx(H,{children:"Cancel"}),e.jsx(G,{disabled:l.isPending||!m||m===t.InstanceType,onClick:L,children:l.isPending?"Saving…":"Save Changes"})]})]})}),e.jsx(ke,{instanceId:t.InstanceId,onOpenChange:f,open:v})]})}export{Ke as component};
